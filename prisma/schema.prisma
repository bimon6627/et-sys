datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// --- GLOBAL SETTINGS (Shared across all conferences) ---

model Whitelist {
  id              Int           @id @default(autoincrement())
  email           String        @unique
  roleId          Int?   
  role            Role?         @relation(fields: [roleId], references: [id])
  regionId        Int?
  region          Region?       @relation("UserToRegion", fields: [regionId], references: [id])
  
  reportedIncidents HMS[]       @relation("ReporterToHMS")
  hmsActions        HMS_actions[] @relation("UserToHMSAction")
}

model Role {
  id          Int          @id @default(autoincrement())
  name        String       @unique
  description String?
  users       Whitelist[]
  permissions Permission[] 
}

model Permission {
  id          Int     @id @default(autoincrement())
  slug        String  @unique 
  description String?
  roles       Role[]
}

model Region {
  id            Int @id @default(autoincrement())
  name          String @unique
  internal      Boolean @default(false)
  participants  Participant[] @relation("ParticipantToRegion")
  organizations Organization[] @relation("OrganizationToRegion")
  users         Whitelist[] @relation("UserToRegion")
  
  // ðŸ’¡ Relation to Conference (A region can host multiple conferences)
  conferences   Conference[]
}

model Organization {
  id              Int     @id @default(autoincrement())
  name            String  @unique
  canVote         Boolean

  regionId        Int
  region          Region @relation("OrganizationToRegion", fields: [regionId], references: [id])
  participants    Participant[] @relation("ParticipantToOrganization")
}

model Config {
  id    Int    @id @default(autoincrement())
  key   String @unique
  value String
}

// --- CONFERENCE SPECIFIC MODELS ---

model Conference {
  id          Int       @id @default(autoincrement())
  name        String    
  shortname   String    @unique 
  
  active      Boolean   @default(false)
  archived    Boolean   @default(false)
  
  startDate   DateTime
  endDate     DateTime

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Data belonging to this specific conference
  participants Participant[]
  formReplies  FormReply[]
  cases        Case[]
  hmsIncidents HMS[]

  // ðŸ’¡ Optional: Regional Conference Support
  global      Boolean @default(false)
  regionId    Int?
  region      Region? @relation(fields: [regionId], references: [id])
}

model Participant {
  id              Int   @id @default(autoincrement())
  
  // ðŸ’¡ FIXED: Relation linked to correct field (conferenceId)
  conferenceId    Int
  conference      Conference @relation(fields: [conferenceId], references: [id])

  name            String
  
  // ðŸ’¡ FIXED: Removed @unique. Uniqueness is handled by @@unique below.
  email           String 
  
  tel             String
  type            ParticipantType
  participant_id  String? 
  gender          Gender
  dob             DateTime
  mealPreference  String?
  allergy         String?
  hotel           String?
  arrival         String?
  departure       String?
  
  family          String
  family_relation String
  family_tel      String

  school_contact           String
  school_contact_relation  String
  school_contact_tel       String
  
  previousConferences      Int
  elected_representative   Boolean

  docs_approved_once       Boolean @default(false)
  docs_approved_twice      Boolean @default(false)
  
  room_number     String?
  notes           String?

  checked_in      Boolean @default(false)
  isAbsent        Boolean @default(false)

  // Relations
  regionId        Int
  region          Region @relation("ParticipantToRegion", fields: [regionId], references: [id])

  organizationId  Int
  organization    Organization  @relation("ParticipantToOrganization", fields: [organizationId], references: [id])

  hms             HMS[] @relation("ParticipantToHMS")
  cases           Case[]  @relation("ParticipantToCases")

  // ðŸ’¡ Composite Key: Ensures email is unique ONLY within this specific conference
  @@unique([email, conferenceId])
}

model FormReply {
  id              Int              @id @default(autoincrement())
  
  conferenceId    Int
  conference      Conference       @relation(fields: [conferenceId], references: [id])

  name            String
  email           String
  tel             String
  county          String
  type            ParticipantType
  participant_id  String
  from            DateTime
  to              DateTime
  reason          String

  has_observer    Boolean?
  observer_name   String?
  observer_id     String?
  observer_tel    String?

  case            Case?           @relation("FormReplyToCase")
}

model Case {
  id              Int               @id @default(autoincrement())
  
  conferenceId    Int
  conference      Conference        @relation(fields: [conferenceId], references: [id])

  formReplyId     Int               @unique
  formReply       FormReply         @relation("FormReplyToCase", fields: [formReplyId], references: [id])
  
  id_swapped      Boolean           @default(false)
  status          Boolean?
  reason_rejected String?
  comment         String?
  reviewedById    Int?
  reviewedBy      String?
  reviewedAt      DateTime?
  hmsFlag         Boolean           @default(false)

  hmsIncidentId   Int? @unique
  hmsIncident     HMS? @relation("CaseToHMS")

  participantObjectId Int? 
  participant     Participant? @relation("ParticipantToCases", fields: [participantObjectId], references: [id])
}

model HMS {
  id               Int       @id @default(autoincrement())
  
  conferenceId     Int
  conference       Conference @relation(fields: [conferenceId], references: [id])

  // Incident Details
  incidentType     HmsType 
  description      String
  location         String?   
  timeOfIncident   DateTime  @default(now())
  
  // Participant Details
  participantId    String?   
  participantName  String?   
  
  participantObjectId Int?
  participantObject Participant? @relation("ParticipantToHMS", fields: [participantObjectId], references: [id])

  // Reporting Details
  reportedById     Int       
  reportedBy       Whitelist @relation("ReporterToHMS", fields: [reportedById], references: [id])
  createdAt        DateTime  @default(now())
  
  // Actions
  actions          HMS_actions[] @relation("HmsIncidentActions")
  caseId           Int?  @unique
  case             Case? @relation("CaseToHMS", fields: [caseId], references: [id])
}

model HMS_actions {
  id          Int      @id @default(autoincrement())
  
  hmsIncidentId Int
  hmsIncident   HMS      @relation("HmsIncidentActions", fields: [hmsIncidentId], references: [id])
  
  userId      Int
  user        Whitelist @relation("UserToHMSAction", fields: [userId], references: [id])
  action      String   
  timestamp   DateTime @default(now())
}

enum HmsType {
  ILLNESS
  ACCIDENT
  ALLERGY
  OTHER
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum ParticipantType {
  DELEGATE
  OBSERVER
}