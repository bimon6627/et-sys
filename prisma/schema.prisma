datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model Whitelist {
  id       Int      @id @default(autoincrement())
  email    String   @unique
  roleId  Int?   
  role    Role?  @relation(fields: [roleId], references: [id])
  regionId  Int?
  region    Region? @relation("UserToRegion", fields: [regionId], references: [id])
  reportedIncidents HMS[]     @relation("ReporterToHMS")
  hmsActions        HMS_actions[] @relation("UserToHMSAction")
}

model FormReply {
  id              Int              @id @default(autoincrement())
  name            String
  email           String
  tel             String
  county          String
  type            ParticipantType
  participant_id  String
  from            DateTime
  to              DateTime
  reason          String

  has_observer    Boolean?
  observer_name   String?
  observer_id     String?
  observer_tel    String?

  case            Case?           @relation("FormReplyToCase")
}

model Case {
  id              Int               @id @default(autoincrement())
  formReplyId     Int               @unique
  formReply       FormReply         @relation("FormReplyToCase", fields: [formReplyId], references: [id])
  id_swapped      Boolean           @default(false)
  status          Boolean?
  reason_rejected String?
  comment         String?
  reviewedById    Int?
  reviewedBy      String?
  reviewedAt      DateTime?
  hmsFlag         Boolean           @default(false)

  hmsIncidentId Int? @unique
  hmsIncident   HMS? @relation("CaseToHMS")

  participantObjectId Int? 
  participant     Participant? @relation("ParticipantToCases", fields: [participantObjectId], references: [id])
}

model Config {
  id    Int  @id @default(autoincrement())
  key   String @unique
  value String
}

model Role {
  id          Int          @id @default(autoincrement())
  name        String       @unique
  description String?
  
  users       Whitelist[]
  permissions Permission[] 
}

model Permission {
  id          Int     @id @default(autoincrement())
  slug        String  @unique 
  description String?

  roles       Role[]
}

model HMS {
  id               Int       @id @default(autoincrement())
  
  // Incident Details
  incidentType     HmsType 
  description      String
  location         String?   // Where did it happen?
  timeOfIncident   DateTime  @default(now())
  
  // Participant Details (Who was involved)
  participantId    String?   // Identifier of the participant (e.g., skiltnr.)
  participantName  String?   
  
  participantObjectId Int?
  participantObject Participant? @relation("ParticipantToHMS", fields: [participantObjectId], references: [id])

  // Reporting Details
  reportedById     Int       // Foreign key to the Whitelist table (the person logging the event)
  reportedBy       Whitelist @relation("ReporterToHMS", fields: [reportedById], references: [id])
  createdAt        DateTime  @default(now())
  
  // Actions taken related to this incident
  actions          HMS_actions[] @relation("HmsIncidentActions")
  caseId        Int?  @unique
  case          Case? @relation("CaseToHMS", fields: [caseId], references: [id])
}

// ðŸ’¡ Link actions back to the specific HMS incident
model HMS_actions {
  id          Int      @id @default(autoincrement())
  
  // Link to the incident
  hmsIncidentId Int
  hmsIncident   HMS      @relation("HmsIncidentActions", fields: [hmsIncidentId], references: [id])
  
  // Details of the action taken
  userId      Int
  user        Whitelist @relation("UserToHMSAction", fields: [userId], references: [id])
  action      String   // e.g., "Contacted participant's team leader", "Administered first aid"
  timestamp   DateTime @default(now())
}

// ðŸ’¡ New Enum for incident categorization
enum HmsType {
  ILLNESS
  ACCIDENT
  ALLERGY
  OTHER
}

model Participant {
  id              Int   @id @default(autoincrement())
  name            String
  email           String @unique
  tel             String
  type            ParticipantType
  participant_id  String?
  gender          Gender
  dob             DateTime
  mealPreference  String?
  allergy         String?
  hotel           String?
  arrival         String?
  departure       String?
  
  family          String
  family_relation String
  family_tel      String

  school_contact          String
  school_contact_relation String
  school_contact_tel      String
  
  previousConferences     Int
  elected_representative  Boolean

  docs_approved_once      Boolean @default(false)
  docs_approved_twice     Boolean @default(false)
  
  room_number     String?
  notes           String?

  checked_in      Boolean @default(false)
  
  hms             HMS[] @relation("ParticipantToHMS")

  regionId        Int
  region          Region @relation("ParticipantToRegion", fields: [regionId], references: [id])

  organizationId  Int
  organization    Organization  @relation("ParticipantToOrganization", fields: [organizationId], references: [id])

  cases           Case[]  @relation("ParticipantToCases")
  isAbsent        Boolean @default(false)
}

model Region {
  id            Int @id @default(autoincrement())
  name          String @unique
  internal      Boolean @default(false)
  participants  Participant[] @relation("ParticipantToRegion")
  organizations Organization[] @relation("OrganizationToRegion")
  users         Whitelist[] @relation("UserToRegion")
}

model Organization {
  id              Int     @id @default(autoincrement())
  name            String  @unique
  canVote         Boolean

  regionId        Int
  region          Region @relation("OrganizationToRegion", fields: [regionId], references: [id])
  participants    Participant[] @relation("ParticipantToOrganization")
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum ParticipantType {
  DELEGATE
  OBSERVER
}